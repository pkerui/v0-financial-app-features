# å¤šåº—åŠŸèƒ½ç•Œé¢é›†æˆæ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**é›¶ç ´åæ€§é›†æˆ** - ç°æœ‰å•åº—åŠŸèƒ½å®Œå…¨ä¿ç•™ï¼Œå¤šåº—åŠŸèƒ½ä½œä¸ºç‹¬ç«‹æ¨¡å—å åŠ 

### è®¾è®¡ç†å¿µ

```
ç°æœ‰å•åº—åŠŸèƒ½ (ä¿æŒä¸å˜)
     â†“
   å¢åŠ 
     â†“
åº—é“ºåˆ‡æ¢å™¨ (å…¨å±€)
     â†“
   å¯ç”¨
     â†“
å¤šåº—ç®¡ç†ç•Œé¢ (æ–°å¢)
```

---

## ğŸ“‹ é›†æˆæ¶æ„

### 1. å¯¼èˆªç»“æ„è®¾è®¡

#### æ–¹æ¡ˆï¼šé¡¶éƒ¨å¢åŠ ã€Œåº—é“ºåˆ‡æ¢å™¨ã€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Logo] æ°‘å®¿è´¢åŠ¡ç®¡ç†ç³»ç»Ÿ                    [åº—é“ºé€‰æ‹©å™¨] â”‚
â”‚                                             [ç”¨æˆ·èœå•]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Š æ€»è§ˆ  ğŸ’° æ”¶æ”¯  ğŸ“ˆ æŠ¥è¡¨  âš™ï¸ è®¾ç½®  ğŸª å¤šåº—ç®¡ç†        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åº—é“ºé€‰æ‹©å™¨**ï¼ˆå³ä¸Šè§’ï¼‰:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸª å½“å‰åº—é“º: æœé˜³åº—  â”‚ â–¼
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… æœé˜³åº— (BJ001)    â”‚ â† å½“å‰é€‰ä¸­
â”‚    æµ·æ·€åº— (BJ002)    â”‚
â”‚    æµ¦ä¸œåº— (SH001)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Š æŸ¥çœ‹å…¨éƒ¨åº—é“º      â”‚ â† è·³è½¬å¤šåº—ç®¡ç†
â”‚ âš™ï¸  åº—é“ºç®¡ç†         â”‚ â† è·³è½¬åº—é“ºè®¾ç½®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. åŠŸèƒ½æ¨¡å¼åˆ‡æ¢

#### æ¨¡å¼è¯´æ˜

| æ¨¡å¼ | è§¦å‘æ¡ä»¶ | é¡µé¢è¡Œä¸º | æ•°æ®èŒƒå›´ |
|------|---------|---------|---------|
| **å•åº—æ¨¡å¼** | é€‰æ‹©äº†æŸä¸ªåº—é“º | ç°æœ‰é¡µé¢æ­£å¸¸æ˜¾ç¤º | ä»…è¯¥åº—é“ºæ•°æ® |
| **å¤šåº—æ¨¡å¼** | é€‰æ‹©ã€Œå…¨éƒ¨åº—é“ºã€ | æ˜¾ç¤ºæ±‡æ€»è§†å›¾ | æ‰€æœ‰åº—é“ºæ±‡æ€» |
| **ç®¡ç†æ¨¡å¼** | ç‚¹å‡»ã€Œå¤šåº—ç®¡ç†ã€ | è·³è½¬ä¸“å±é¡µé¢ | ç®¡ç†åŠŸèƒ½ |

#### å®ç°æ–¹å¼

```typescript
// lib/contexts/store-context.tsx
import { createContext, useContext, useState } from 'react'

type StoreMode = 'single' | 'multi'

interface StoreContextValue {
  // å½“å‰é€‰æ‹©
  selectedStoreId: string | null  // null = å…¨éƒ¨åº—é“º
  mode: StoreMode

  // æ“ä½œ
  selectStore: (storeId: string | null) => void
  switchToMultiMode: () => void
  switchToSingleMode: (storeId: string) => void
}

export const StoreContext = createContext<StoreContextValue>(...)

export function StoreProvider({ children }) {
  const [selectedStoreId, setSelectedStoreId] = useState<string | null>(null)

  const mode = selectedStoreId === null ? 'multi' : 'single'

  return (
    <StoreContext.Provider value={{
      selectedStoreId,
      mode,
      selectStore: setSelectedStoreId,
      switchToMultiMode: () => setSelectedStoreId(null),
      switchToSingleMode: setSelectedStoreId
    }}>
      {children}
    </StoreContext.Provider>
  )
}

export const useStore = () => useContext(StoreContext)
```

---

## ğŸ—‚ï¸ é¡µé¢è·¯ç”±è®¾è®¡

### æ–°å¢è·¯ç”±ï¼ˆä¸å½±å“ç°æœ‰ï¼‰

```
ç°æœ‰è·¯ç”± (ä¿æŒä¸å˜):
  /dashboard              # æ€»è§ˆ
  /income                 # æ”¶å…¥
  /expense                # æ”¯å‡º
  /transactions           # äº¤æ˜“è®°å½•
  /cash-flow              # ç°é‡‘æµé‡è¡¨
  /profit-loss            # åˆ©æ¶¦è¡¨
  /settings               # è®¾ç½®

æ–°å¢è·¯ç”± (å¤šåº—ä¸“å±):
  /multi-store            # å¤šåº—ç®¡ç†ä¸»é¡µ
  /multi-store/overview   # å¤šåº—æ€»è§ˆ
  /multi-store/stores     # åº—é“ºç®¡ç†
  /multi-store/comparison # åº—é“ºå¯¹æ¯”
  /multi-store/regional   # åŒºåŸŸåˆ†æ
```

### æ™ºèƒ½è·¯ç”±ç­–ç•¥

```typescript
// app/dashboard/page.tsx (ç°æœ‰é¡µé¢ï¼Œå¢å¼º)
export default async function DashboardPage() {
  const { selectedStoreId } = useStore()

  // æ ¹æ®æ¨¡å¼åŠ è½½ä¸åŒç»„ä»¶
  if (selectedStoreId === null) {
    // å¤šåº—æ¨¡å¼ï¼šæ˜¾ç¤ºæ±‡æ€»æ•°æ®
    return <MultiStoreDashboard />
  } else {
    // å•åº—æ¨¡å¼ï¼šæ˜¾ç¤ºå•åº—æ•°æ®ï¼ˆç°æœ‰é€»è¾‘ï¼‰
    return <SingleStoreDashboard storeId={selectedStoreId} />
  }
}
```

---

## ğŸ¨ ç•Œé¢é›†æˆè¯¦ç»†æ–¹æ¡ˆ

### 1. é¡¶éƒ¨å¯¼èˆªæ å¢å¼º

**ä½ç½®**: `components/navbar.tsx` æˆ– `app/layout.tsx`

**æ–°å¢ç»„ä»¶**: `components/store-selector.tsx`

```typescript
// components/store-selector.tsx
'use client'

import { useState } from 'react'
import { useStore } from '@/lib/contexts/store-context'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { Building2, LayoutDashboard, Settings } from 'lucide-react'

export function StoreSelector({ stores }: { stores: Store[] }) {
  const { selectedStoreId, selectStore, switchToMultiMode } = useStore()

  return (
    <Select
      value={selectedStoreId || 'all'}
      onValueChange={(value) => {
        if (value === 'all') {
          switchToMultiMode()
        } else if (value === 'manage') {
          window.location.href = '/multi-store/stores'
        } else {
          selectStore(value)
        }
      }}
    >
      <SelectTrigger className="w-[200px]">
        <Building2 className="mr-2 h-4 w-4" />
        <SelectValue placeholder="é€‰æ‹©åº—é“º" />
      </SelectTrigger>
      <SelectContent>
        {/* å½“å‰é€‰ä¸­åº—é“º */}
        {stores.map(store => (
          <SelectItem key={store.id} value={store.id}>
            {store.name} ({store.code})
          </SelectItem>
        ))}

        {/* åˆ†éš”çº¿ */}
        <div className="my-1 border-t" />

        {/* å¤šåº—é€‰é¡¹ */}
        <SelectItem value="all">
          <div className="flex items-center">
            <LayoutDashboard className="mr-2 h-4 w-4" />
            æŸ¥çœ‹å…¨éƒ¨åº—é“º
          </div>
        </SelectItem>

        <SelectItem value="manage">
          <div className="flex items-center">
            <Settings className="mr-2 h-4 w-4" />
            åº—é“ºç®¡ç†
          </div>
        </SelectItem>
      </SelectContent>
    </Select>
  )
}
```

**é›†æˆåˆ°å¸ƒå±€**:

```typescript
// app/layout.tsx (ä¿®æ”¹)
import { StoreProvider } from '@/lib/contexts/store-context'
import { StoreSelector } from '@/components/store-selector'

export default async function RootLayout({ children }) {
  const { data: stores } = await getActiveStores()

  return (
    <html>
      <body>
        <StoreProvider>
          {/* å¯¼èˆªæ  */}
          <nav>
            <div className="flex justify-between items-center">
              <Logo />

              {/* åº—é“ºé€‰æ‹©å™¨ (æ–°å¢) */}
              <StoreSelector stores={stores} />

              <UserMenu />
            </div>
          </nav>

          {/* ä¸»å†…å®¹ */}
          <main>{children}</main>
        </StoreProvider>
      </body>
    </html>
  )
}
```

### 2. ä¾§è¾¹å¯¼èˆªå¢å¼º

**ä½ç½®**: `components/sidebar.tsx`

**æ–°å¢å¯¼èˆªé¡¹**:

```typescript
const navigationItems = [
  // ç°æœ‰é¡¹ç›® (ä¿æŒä¸å˜)
  { name: 'æ€»è§ˆ', href: '/dashboard', icon: Home },
  { name: 'æ”¶å…¥æ˜ç»†', href: '/income', icon: TrendingUp },
  { name: 'æ”¯å‡ºæ˜ç»†', href: '/expense', icon: TrendingDown },
  { name: 'äº¤æ˜“è®°å½•', href: '/transactions', icon: Receipt },
  { name: 'ç°é‡‘æµé‡è¡¨', href: '/cash-flow', icon: Activity },
  { name: 'åˆ©æ¶¦è¡¨', href: '/profit-loss', icon: BarChart },

  // åˆ†éš”çº¿
  { type: 'separator' },

  // æ–°å¢å¤šåº—ç®¡ç† (ä»…å¤šåº—é“ºç”¨æˆ·å¯è§)
  {
    name: 'å¤šåº—ç®¡ç†',
    href: '/multi-store',
    icon: Building2,
    badge: stores.length > 1 ? stores.length : null  // æ˜¾ç¤ºåº—é“ºæ•°é‡
  },

  { type: 'separator' },

  // è®¾ç½®
  { name: 'è´¢åŠ¡è®¾ç½®', href: '/settings', icon: Settings },
]
```

### 3. ç°æœ‰é¡µé¢é€‚é…ï¼ˆæœ€å°æ”¹åŠ¨ï¼‰

#### æ–¹æ¡ˆA: ç»„ä»¶çº§é€‚é…ï¼ˆæ¨èï¼‰

```typescript
// app/dashboard/page.tsx (ç°æœ‰æ–‡ä»¶ï¼Œè½»å¾®ä¿®æ”¹)
import { useStore } from '@/lib/contexts/store-context'
import { SingleStoreDashboard } from '@/components/single-store-dashboard'
import { MultiStoreDashboard } from '@/components/multi-store-dashboard'

export default function DashboardPage() {
  const { mode, selectedStoreId } = useStore()

  // æ ¹æ®æ¨¡å¼åˆ‡æ¢ç»„ä»¶
  if (mode === 'multi') {
    return <MultiStoreDashboard />
  }

  // å•åº—æ¨¡å¼ï¼šä½¿ç”¨ç°æœ‰é€»è¾‘
  return <SingleStoreDashboard storeId={selectedStoreId} />
}
```

**å°†ç°æœ‰ä»£ç å°è£…ä¸ºç»„ä»¶**:

```typescript
// components/single-store-dashboard.tsx (æ–°æ–‡ä»¶)
// å°† app/dashboard/page.tsx çš„ç°æœ‰ä»£ç ç§»åˆ°è¿™é‡Œ
export function SingleStoreDashboard({ storeId }: { storeId: string }) {
  // åŸæœ‰çš„ dashboard é€»è¾‘
  const { data } = await getStoreSummary(storeId)

  return (
    <div>
      {/* åŸæœ‰çš„ dashboard UI */}
    </div>
  )
}
```

#### æ–¹æ¡ˆB: æ•°æ®å±‚é€‚é…ï¼ˆæ›´ä¼˜é›…ï¼‰

```typescript
// lib/api/dashboard.ts (ä¿®æ”¹)
export async function getDashboardData(storeId?: string | null) {
  if (!storeId || storeId === 'all') {
    // å¤šåº—æ¨¡å¼ï¼šè¿”å›æ±‡æ€»æ•°æ®
    return await getMultiStoreSummary()
  } else {
    // å•åº—æ¨¡å¼ï¼šè¿”å›å•åº—æ•°æ®ï¼ˆç°æœ‰é€»è¾‘ï¼‰
    return await getSingleStoreSummary(storeId)
  }
}

// app/dashboard/page.tsx (ç°æœ‰æ–‡ä»¶ï¼Œåªæ”¹æ•°æ®è·å–)
export default async function DashboardPage({ searchParams }) {
  const storeId = searchParams.store  // ä» URL è·å–
  const data = await getDashboardData(storeId)

  // UI ä¿æŒä¸å˜ï¼Œæ•°æ®è‡ªåŠ¨é€‚é…
  return <DashboardUI data={data} />
}
```

---

## ğŸ“Š å„é¡µé¢é€‚é…ç­–ç•¥

### æ€»è§ˆé¡µ (`/dashboard`)

**ç°æœ‰åŠŸèƒ½**: æ˜¾ç¤ºå•åº—æ€»è§ˆæ•°æ®

**é€‚é…æ–¹å¼**:
```typescript
if (mode === 'multi') {
  return (
    <div>
      {/* å¤šåº—æ±‡æ€»å¡ç‰‡ */}
      <SummaryCards data={multiStoreData} />

      {/* åº—é“ºå¯¹æ¯”å›¾ */}
      <StoreComparisonChart stores={allStores} />

      {/* å¿«é€Ÿé“¾æ¥ */}
      <QuickLinks />
    </div>
  )
} else {
  return <ExistingDashboard storeId={selectedStoreId} />
}
```

### æ”¶å…¥/æ”¯å‡ºé¡µ (`/income`, `/expense`)

**ç°æœ‰åŠŸèƒ½**: æ˜¾ç¤ºæ”¶å…¥/æ”¯å‡ºæ˜ç»†

**é€‚é…æ–¹å¼**:
```typescript
// æ•°æ®æŸ¥è¯¢æ—¶å¢åŠ åº—é“ºè¿‡æ»¤
const { data } = await getTransactions({
  type: 'income',
  storeId: selectedStoreId,  // null = å…¨éƒ¨ï¼Œæœ‰å€¼ = å•åº—
  ...otherFilters
})

// UI å¢åŠ åº—é“ºåˆ—æ˜¾ç¤ºï¼ˆå¤šåº—æ¨¡å¼ï¼‰
if (mode === 'multi') {
  columns.push({
    header: 'æ‰€å±åº—é“º',
    cell: (row) => row.store_name
  })
}
```

### äº¤æ˜“è®°å½•é¡µ (`/transactions`)

**ç°æœ‰åŠŸèƒ½**: æ˜¾ç¤ºæ‰€æœ‰äº¤æ˜“

**é€‚é…æ–¹å¼**:
```typescript
// ç­›é€‰å™¨å¢åŠ åº—é“ºé€‰é¡¹
<Filters>
  <TypeFilter />
  <DateRangeFilter />

  {/* æ–°å¢ï¼šå¤šåº—æ¨¡å¼ä¸‹æ˜¾ç¤ºåº—é“ºç­›é€‰ */}
  {mode === 'multi' && (
    <StoreFilter stores={stores} />
  )}
</Filters>

// è¡¨æ ¼å¢åŠ åº—é“ºåˆ—
<Table
  columns={[
    ...existingColumns,
    mode === 'multi' && { header: 'åº—é“º', accessor: 'store_name' }
  ].filter(Boolean)}
/>
```

### ç°é‡‘æµé‡è¡¨ (`/cash-flow`)

**ç°æœ‰åŠŸèƒ½**: å•åº—ç°é‡‘æµé‡è¡¨

**é€‚é…æ–¹å¼**:
```typescript
// é¡¶éƒ¨å¢åŠ æ¨¡å¼åˆ‡æ¢æç¤º
{mode === 'multi' && (
  <Alert>
    <Info className="h-4 w-4" />
    <AlertDescription>
      å½“å‰æ˜¾ç¤ºæ‰€æœ‰åº—é“ºæ±‡æ€»æ•°æ®ã€‚
      <Link href="?mode=comparison">åˆ‡æ¢åˆ°åº—é“ºå¯¹æ¯”æ¨¡å¼</Link>
    </AlertDescription>
  </Alert>
)}

// æ•°æ®è®¡ç®—é€»è¾‘
const cashFlowData = mode === 'multi'
  ? await calculateMultiStoreCashFlow(companyId, dateRange)
  : await calculateSingleStoreCashFlow(selectedStoreId, dateRange)

// UI ä¿æŒä¸å˜ï¼Œæ•°æ®è‡ªåŠ¨é€‚é…
```

### åˆ©æ¶¦è¡¨ (`/profit-loss`)

**é€‚é…æ–¹å¼**: åŒç°é‡‘æµé‡è¡¨

---

## ğŸ†• æ–°å¢å¤šåº—ç®¡ç†é¡µé¢

### ä¸»é¡µ (`/multi-store`)

```typescript
// app/multi-store/page.tsx
export default function MultiStoreHomePage() {
  return (
    <div className="space-y-6">
      {/* æ¬¢è¿åŒºåŸŸ */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold">å¤šåº—é“ºç®¡ç†</h1>
          <p className="text-muted-foreground">
            ç®¡ç†æ‚¨çš„ {storeCount} å®¶åº—é“º
          </p>
        </div>
        <Button onClick={() => router.push('/multi-store/stores/new')}>
          <Plus className="mr-2 h-4 w-4" />
          æ–°å¢åº—é“º
        </Button>
      </div>

      {/* å¿«é€Ÿå¯¼èˆªå¡ç‰‡ */}
      <div className="grid grid-cols-4 gap-4">
        <QuickActionCard
          title="åº—é“ºæ€»è§ˆ"
          description="æŸ¥çœ‹æ‰€æœ‰åº—é“ºæ±‡æ€»æ•°æ®"
          icon={LayoutDashboard}
          href="/multi-store/overview"
        />
        <QuickActionCard
          title="åº—é“ºç®¡ç†"
          description="ç®¡ç†åº—é“ºä¿¡æ¯å’ŒçŠ¶æ€"
          icon={Building2}
          href="/multi-store/stores"
        />
        <QuickActionCard
          title="åº—é“ºå¯¹æ¯”"
          description="å¯¹æ¯”åˆ†æåº—é“ºè¡¨ç°"
          icon={BarChart}
          href="/multi-store/comparison"
        />
        <QuickActionCard
          title="åŒºåŸŸåˆ†æ"
          description="æŒ‰åŒºåŸŸæŸ¥çœ‹ç»è¥æ•°æ®"
          icon={Map}
          href="/multi-store/regional"
        />
      </div>

      {/* æ¦‚è§ˆæ•°æ® */}
      <div className="grid grid-cols-3 gap-4">
        <SummaryCard
          title="æ€»æ”¶å…¥ï¼ˆæœ¬æœˆï¼‰"
          value="Â¥500,000"
          trend={+15}
        />
        <SummaryCard
          title="æ€»æ”¯å‡ºï¼ˆæœ¬æœˆï¼‰"
          value="Â¥350,000"
          trend={+12}
        />
        <SummaryCard
          title="å‡€åˆ©æ¶¦ï¼ˆæœ¬æœˆï¼‰"
          value="Â¥150,000"
          trend={+20}
        />
      </div>

      {/* åº—é“ºè¡¨ç°æ’è¡Œ */}
      <Card>
        <CardHeader>
          <CardTitle>åº—é“ºè¡¨ç°æ’è¡Œï¼ˆæœ¬æœˆï¼‰</CardTitle>
        </CardHeader>
        <CardContent>
          <StoreRankingTable stores={rankedStores} />
        </CardContent>
      </Card>
    </div>
  )
}
```

### åº—é“ºç®¡ç† (`/multi-store/stores`)

```typescript
// app/multi-store/stores/page.tsx
export default function StoresManagementPage() {
  return (
    <div>
      {/* ç­›é€‰å’Œæœç´¢ */}
      <div className="flex gap-4 mb-6">
        <StatusFilter />
        <RegionFilter />
        <SearchInput placeholder="æœç´¢åº—é“º..." />
      </div>

      {/* åº—é“ºç½‘æ ¼ */}
      <div className="grid grid-cols-3 gap-4">
        {stores.map(store => (
          <StoreCard
            key={store.id}
            store={store}
            onEdit={() => router.push(`/multi-store/stores/${store.id}/edit`)}
            onView={() => selectStore(store.id)}
          />
        ))}
      </div>
    </div>
  )
}

// components/store-card.tsx
function StoreCard({ store, onEdit, onView }) {
  return (
    <Card>
      <CardHeader>
        <div className="flex justify-between">
          <div>
            <CardTitle>{store.name}</CardTitle>
            <p className="text-sm text-muted-foreground">{store.code}</p>
          </div>
          <Badge variant={store.status === 'active' ? 'default' : 'secondary'}>
            {store.status}
          </Badge>
        </div>
      </CardHeader>
      <CardContent>
        <div className="space-y-2 text-sm">
          <div className="flex justify-between">
            <span>ä»Šæ—¥æ”¶å…¥</span>
            <span className="font-semibold">Â¥{store.todayIncome}</span>
          </div>
          <div className="flex justify-between">
            <span>æœ¬æœˆæ”¶å…¥</span>
            <span className="font-semibold">Â¥{store.monthIncome}</span>
          </div>
        </div>
      </CardContent>
      <CardFooter className="gap-2">
        <Button variant="outline" size="sm" onClick={onView}>
          æŸ¥çœ‹è¯¦æƒ…
        </Button>
        <Button variant="ghost" size="sm" onClick={onEdit}>
          ç¼–è¾‘
        </Button>
      </CardFooter>
    </Card>
  )
}
```

### åº—é“ºå¯¹æ¯” (`/multi-store/comparison`)

```typescript
// app/multi-store/comparison/page.tsx
export default function StoreComparisonPage() {
  const [selectedStores, setSelectedStores] = useState<string[]>([])

  return (
    <div>
      {/* åº—é“ºé€‰æ‹© */}
      <Card className="mb-6">
        <CardHeader>
          <CardTitle>é€‰æ‹©è¦å¯¹æ¯”çš„åº—é“º</CardTitle>
        </CardHeader>
        <CardContent>
          <MultiSelect
            options={stores}
            value={selectedStores}
            onChange={setSelectedStores}
            max={5}  // æœ€å¤šé€‰5ä¸ª
          />
        </CardContent>
      </Card>

      {/* å¯¹æ¯”å›¾è¡¨ */}
      <div className="grid grid-cols-2 gap-6">
        {/* æ”¶å…¥å¯¹æ¯” */}
        <Card>
          <CardHeader>
            <CardTitle>æ”¶å…¥å¯¹æ¯”</CardTitle>
          </CardHeader>
          <CardContent>
            <BarChart data={comparisonData.income} />
          </CardContent>
        </Card>

        {/* åˆ©æ¶¦å¯¹æ¯” */}
        <Card>
          <CardHeader>
            <CardTitle>åˆ©æ¶¦å¯¹æ¯”</CardTitle>
          </CardHeader>
          <CardContent>
            <BarChart data={comparisonData.profit} />
          </CardContent>
        </Card>

        {/* è¶‹åŠ¿å¯¹æ¯” */}
        <Card className="col-span-2">
          <CardHeader>
            <CardTitle>æ”¶å…¥è¶‹åŠ¿å¯¹æ¯”</CardTitle>
          </CardHeader>
          <CardContent>
            <LineChart data={comparisonData.trend} />
          </CardContent>
        </Card>

        {/* é›·è¾¾å›¾ */}
        <Card className="col-span-2">
          <CardHeader>
            <CardTitle>ç»¼åˆæŒ‡æ ‡å¯¹æ¯”</CardTitle>
          </CardHeader>
          <CardContent>
            <RadarChart
              data={comparisonData.radar}
              metrics={['æ”¶å…¥', 'åˆ©æ¶¦', 'å¢é•¿ç‡', 'å®¢å•ä»·', 'äº¤æ˜“é‡']}
            />
          </CardContent>
        </Card>
      </div>
    </div>
  )
}
```

---

## ğŸ”„ æ•°æ®æŸ¥è¯¢é€‚é…

### ç»Ÿä¸€æŸ¥è¯¢æ¥å£

```typescript
// lib/api/unified-query.ts
export async function getFinancialData(
  type: 'transactions' | 'summary' | 'cash-flow' | 'profit-loss',
  options: {
    companyId: string
    storeId?: string | null  // null = å…¨éƒ¨ï¼Œæœ‰å€¼ = å•åº—
    dateRange: DateRange
    filters?: any
  }
) {
  const { companyId, storeId, dateRange, filters } = options

  // æ„å»ºåŸºç¡€æŸ¥è¯¢
  let query = supabase
    .from(getTableName(type))
    .select('*')
    .eq('company_id', companyId)
    .gte('date', dateRange.start)
    .lte('date', dateRange.end)

  // å•åº—æ¨¡å¼ï¼šæ·»åŠ åº—é“ºè¿‡æ»¤
  if (storeId) {
    query = query.eq('store_id', storeId)
  }

  // å¤šåº—æ¨¡å¼ï¼šå¯èƒ½éœ€è¦ JOIN åº—é“ºä¿¡æ¯
  if (!storeId && type === 'transactions') {
    query = query.select('*, stores(name, code)')
  }

  const { data, error } = await query

  return { data, error }
}
```

---

## ğŸ¨ UI ç»„ä»¶å¤ç”¨

### é€šç”¨ç»„ä»¶åº“

```typescript
// components/multi-store/
â”œâ”€â”€ store-selector.tsx          # åº—é“ºé€‰æ‹©å™¨
â”œâ”€â”€ store-card.tsx              # åº—é“ºå¡ç‰‡
â”œâ”€â”€ store-comparison-chart.tsx  # å¯¹æ¯”å›¾è¡¨
â”œâ”€â”€ store-ranking-table.tsx     # æ’è¡Œæ¦œ
â”œâ”€â”€ regional-map.tsx            # åŒºåŸŸåœ°å›¾
â”œâ”€â”€ summary-cards.tsx           # æ±‡æ€»å¡ç‰‡
â””â”€â”€ quick-action-card.tsx       # å¿«é€Ÿæ“ä½œå¡ç‰‡
```

### å¤ç”¨ç°æœ‰ç»„ä»¶

```typescript
// ç°æœ‰ç»„ä»¶å¯ä»¥ç›´æ¥å¤ç”¨
import { Card } from '@/components/ui/card'
import { DataTable } from '@/components/data-table'
import { DateRangePicker } from '@/components/date-range-picker'

// åªéœ€æ–°å¢å¤šåº—ç‰¹æœ‰ç»„ä»¶
import { StoreSelector } from '@/components/multi-store/store-selector'
import { StoreComparisonChart } from '@/components/multi-store/comparison-chart'
```

---

## ğŸ“± å“åº”å¼è®¾è®¡

### ç§»åŠ¨ç«¯é€‚é…

```typescript
// åº—é“ºé€‰æ‹©å™¨åœ¨ç§»åŠ¨ç«¯æ˜¾ç¤ºä¸ºåº•éƒ¨æŠ½å±‰
<div className="hidden md:block">
  <StoreSelector />  {/* æ¡Œé¢ç«¯ï¼šä¸‹æ‹‰é€‰æ‹© */}
</div>

<div className="md:hidden">
  <Button onClick={() => setSheetOpen(true)}>
    <Building2 /> åˆ‡æ¢åº—é“º
  </Button>
  <Sheet open={sheetOpen} onOpenChange={setSheetOpen}>
    <StoreList />  {/* ç§»åŠ¨ç«¯ï¼šåº•éƒ¨æŠ½å±‰ */}
  </Sheet>
</div>
```

---

## âœ… å®æ–½æ£€æŸ¥æ¸…å•

### é˜¶æ®µ1: åŸºç¡€é›†æˆï¼ˆæœ¬æ¬¡å®æ–½ï¼‰

- [ ] åˆ›å»º `StoreContext` å…¨å±€ä¸Šä¸‹æ–‡
- [ ] å¼€å‘ `StoreSelector` ç»„ä»¶
- [ ] é›†æˆåˆ°é¡¶éƒ¨å¯¼èˆªæ 
- [ ] å¢åŠ ä¾§è¾¹æ ã€Œå¤šåº—ç®¡ç†ã€èœå•é¡¹
- [ ] åˆ›å»º `/multi-store` ä¸»é¡µ
- [ ] åˆ›å»º `/multi-store/stores` åº—é“ºç®¡ç†é¡µ
- [ ] æµ‹è¯•åº—é“ºåˆ‡æ¢åŠŸèƒ½

### é˜¶æ®µ2: ç°æœ‰é¡µé¢é€‚é…

- [ ] é€‚é… `/dashboard` æ€»è§ˆé¡µ
- [ ] é€‚é… `/transactions` äº¤æ˜“è®°å½•é¡µ
- [ ] é€‚é… `/income` æ”¶å…¥é¡µ
- [ ] é€‚é… `/expense` æ”¯å‡ºé¡µ
- [ ] é€‚é… `/cash-flow` ç°é‡‘æµé‡è¡¨
- [ ] é€‚é… `/profit-loss` åˆ©æ¶¦è¡¨

### é˜¶æ®µ3: é«˜çº§åŠŸèƒ½

- [ ] åº—é“ºå¯¹æ¯”é¡µé¢
- [ ] åŒºåŸŸåˆ†æé¡µé¢
- [ ] å¤šåº—æ±‡æ€»æŠ¥è¡¨
- [ ] æ•°æ®å¯¼å‡ºåŠŸèƒ½

---

## ğŸ’¡ å…³é”®å®æ–½å»ºè®®

### 1. æ¸è¿›å¼é›†æˆ

```
ç¬¬1å‘¨: åº—é“ºåˆ‡æ¢å™¨ + åº—é“ºç®¡ç†é¡µ
ç¬¬2å‘¨: æ€»è§ˆé¡µé€‚é… + äº¤æ˜“è®°å½•é€‚é…
ç¬¬3å‘¨: æŠ¥è¡¨é¡µé¢é€‚é…
ç¬¬4å‘¨: å¯¹æ¯”å’Œåˆ†æåŠŸèƒ½
```

### 2. æ•°æ®å…¼å®¹

```typescript
// ç¡®ä¿ç°æœ‰æ•°æ®ä¸å—å½±å“
// æ‰€æœ‰ç°æœ‰äº¤æ˜“è®°å½•çš„ store_id å¯ä»¥ä¸º NULL
// æŸ¥è¯¢æ—¶è‡ªåŠ¨å¤„ç†

if (transaction.store_id === null) {
  // æ—§æ•°æ®ï¼Œæ˜¾ç¤ºä¸º"æ€»éƒ¨"æˆ–"æœªåˆ†é…"
  transaction.store_name = 'æ€»éƒ¨'
}
```

### 3. ç”¨æˆ·ä½“éªŒ

```typescript
// ä¿å­˜ç”¨æˆ·çš„åº—é“ºé€‰æ‹©åå¥½
localStorage.setItem('selectedStoreId', storeId)

// ä¸‹æ¬¡è®¿é—®è‡ªåŠ¨æ¢å¤
const defaultStoreId = localStorage.getItem('selectedStoreId')
```

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### å•åº—ç”¨æˆ·ä½“éªŒ

- çœ‹ä¸åˆ°åº—é“ºé€‰æ‹©å™¨ï¼ˆåªæœ‰1å®¶åº—ï¼‰
- ç•Œé¢å’Œç°åœ¨å®Œå…¨ä¸€æ ·
- é›¶å­¦ä¹ æˆæœ¬

### å¤šåº—ç”¨æˆ·ä½“éªŒ

- å³ä¸Šè§’éšæ—¶åˆ‡æ¢åº—é“º
- å¯æŸ¥çœ‹å•åº—æˆ–å…¨éƒ¨åº—é“º
- ä¸“å±å¤šåº—ç®¡ç†å…¥å£
- å¼ºå¤§çš„å¯¹æ¯”åˆ†æåŠŸèƒ½

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

âœ… **é›¶ç ´å** - ç°æœ‰åŠŸèƒ½å®Œå…¨ä¿ç•™
âœ… **è½»é›†æˆ** - åªéœ€å¢åŠ é€‰æ‹©å™¨å’Œä¸Šä¸‹æ–‡
âœ… **é«˜å¤ç”¨** - æœ€å¤§åŒ–åˆ©ç”¨ç°æœ‰ç»„ä»¶
âœ… **æ˜“æ‰©å±•** - æ¨¡å—åŒ–è®¾è®¡ï¼Œä¾¿äºè¿­ä»£

### å®æ–½è·¯å¾„

```
ç°æœ‰ç³»ç»Ÿ
    â†“
å¢åŠ  StoreContext
    â†“
å¢åŠ  StoreSelector
    â†“
é€‚é…ç°æœ‰é¡µé¢ï¼ˆæ•°æ®å±‚ï¼‰
    â†“
æ–°å¢å¤šåº—ç®¡ç†é¡µé¢
    â†“
å®Œæˆ âœ…
```

---

**å‡†å¤‡å¥½å¼€å§‹å®æ–½äº†å—ï¼Ÿ** ğŸš€
