# 现金流量表 - 类型分类说明

## 一、核心原则

**所有交易都计入现金净增加额！**

现金流量表记录的是**所有现金的流入和流出**，因此：

```
现金净增加额 = 总流入 - 总流出
            = (所有收入交易) - (所有支出交易)
```

## 二、交易分类逻辑

### 1. 按交易类型分类

所有交易分为两大类：
- **income (收入)** → 现金流入 (+)
- **expense (支出)** → 现金流出 (-)

### 2. 按现金流活动分类

每笔交易都必须归属到三种活动之一：

#### 📊 经营活动 (Operating)
日常经营产生的现金流

**收入类型：**
- 房租收入 ✅
- 服务费收入 ✅
- 其他收入 ✅

**支出类型：**
- 水电费 ✅
- 物业费 ✅
- 维修费 ✅
- 清洁费 ✅
- 网费 ✅
- 管理费 ✅
- 其他支出 ✅

#### 🏗️ 投资活动 (Investing)
长期资产的购建和处置

**支出类型：**
- 装修费 ✅ (购建固定资产)
- 购置设备 ✅
- 房屋改造 ✅

**收入类型：**
- 设备处置收入 ✅
- 资产出售收入 ✅

#### 💰 筹资活动 (Financing)
资金的筹集和偿还

**收入类型：**
- 押金收入 ✅ (收到押金)
- 借款收入 ✅

**支出类型：**
- 押金退还 ✅ (退还押金)
- 偿还借款 ✅

## 三、现金净增加额计算

### 公式

```
总流入 = 经营活动流入 + 投资活动流入 + 筹资活动流入
总流出 = 经营活动流出 + 投资活动流出 + 筹资活动流出

现金净增加额 = 总流入 - 总流出

期末现金余额 = 期初现金余额 + 现金净增加额
```

### 详细展开

```
现金净增加额 = 经营活动现金流量净额
             + 投资活动现金流量净额
             + 筹资活动现金流量净额

其中：
经营活动现金流量净额 = 经营活动流入 - 经营活动流出
投资活动现金流量净额 = 投资活动流入 - 投资活动流出
筹资活动现金流量净额 = 筹资活动流入 - 筹资活动流出
```

## 四、实际案例

### 案例1：纯经营活动

**期间交易：**
- 房租收入: +¥10,000 (经营活动流入)
- 水电费: -¥500 (经营活动流出)
- 物业费: -¥300 (经营活动流出)

**计算：**
```
经营活动净额 = ¥10,000 - ¥500 - ¥300 = ¥9,200
投资活动净额 = ¥0
筹资活动净额 = ¥0

现金净增加额 = ¥9,200
```

### 案例2：包含投资和筹资活动

**期间交易：**
- 房租收入: +¥10,000 (经营)
- 押金收入: +¥5,000 (筹资)
- 水电费: -¥500 (经营)
- 装修费: -¥8,000 (投资)
- 押金退还: -¥3,000 (筹资)

**计算：**
```
经营活动净额 = ¥10,000 - ¥500 = ¥9,500
投资活动净额 = ¥0 - ¥8,000 = -¥8,000
筹资活动净额 = ¥5,000 - ¥3,000 = ¥2,000

现金净增加额 = ¥9,500 - ¥8,000 + ¥2,000 = ¥3,500
```

### 案例3：完整的月度现金流

**初始状态：**
- 期初现金余额: ¥20,000 (2025-03-01)

**3月交易：**
- 房租收入: +¥15,000
- 服务费收入: +¥2,000
- 押金收入: +¥5,000
- 水电费: -¥800
- 物业费: -¥500
- 维修费: -¥1,200
- 装修费: -¥10,000
- 押金退还: -¥5,000

**现金流量表：**
```
一、经营活动：
   流入：房租收入 ¥15,000 + 服务费 ¥2,000 = ¥17,000
   流出：水电费 ¥800 + 物业费 ¥500 + 维修费 ¥1,200 = ¥2,500
   净额：¥14,500

二、投资活动：
   流入：¥0
   流出：装修费 ¥10,000
   净额：-¥10,000

三、筹资活动：
   流入：押金收入 ¥5,000
   流出：押金退还 ¥5,000
   净额：¥0

四、汇总：
   总流入：¥17,000 + ¥0 + ¥5,000 = ¥22,000
   总流出：¥2,500 + ¥10,000 + ¥5,000 = ¥17,500
   现金净增加额：¥22,000 - ¥17,500 = ¥4,500
   期初现金余额：¥20,000
   期末现金余额：¥20,000 + ¥4,500 = ¥24,500
```

## 五、关键要点

### ✅ 所有交易都影响现金

**无论是哪种活动类型，所有交易都会影响现金余额：**

1. **经营活动** - 影响现金 ✅
2. **投资活动** - 影响现金 ✅
3. **筹资活动** - 影响现金 ✅

### ✅ 不存在"不计入现金流"的交易

在现金流量表中：
- ❌ 没有"不计入净增加额"的选项
- ✅ 所有交易都是现金交易，都会影响现金余额
- ✅ 只是分类不同（经营/投资/筹资）

### ⚠️ 与利润表的区别

**利润表** 有 `include_in_profit_loss` 字段：
- ✅ 营业内收入/支出 → 计入利润表
- ❌ 营业外收入/支出 → 不计入利润表（如押金）

**现金流量表** 没有这个概念：
- ✅ 所有收入 → 都是现金流入
- ✅ 所有支出 → 都是现金流出

## 六、系统实现

### 数据库表结构

```sql
CREATE TABLE transaction_categories (
  id UUID PRIMARY KEY,
  name VARCHAR(50) NOT NULL,
  type VARCHAR(10) NOT NULL,  -- 'income' 或 'expense'

  -- 现金流活动类型（所有交易都必须有）
  cash_flow_activity VARCHAR(20) NOT NULL
    CHECK (cash_flow_activity IN ('operating', 'investing', 'financing')),

  -- 是否计入利润表（仅用于利润表，不影响现金流）
  include_in_profit_loss BOOLEAN DEFAULT TRUE,

  ...
);
```

### 代码实现

```typescript
// lib/services/cash-flow.ts

// 1. 所有交易都参与计算
transactions.forEach(transaction => {
  // 确定活动类型
  const activity = transaction.cash_flow_activity || 'operating'

  // 确定方向：收入=流入，支出=流出
  const direction = transaction.type === 'income' ? 'inflow' : 'outflow'

  // 累加到对应的活动类型
  aggregated[activity][direction].add(transaction)
})

// 2. 计算净增加额（包含所有活动）
netIncrease = (operating.inflow - operating.outflow)
            + (investing.inflow - investing.outflow)
            + (financing.inflow - financing.outflow)

// 3. 计算期末余额
endingBalance = beginningBalance + netIncrease
```

## 七、总结

### 📌 重点记忆

1. **100%的交易都计入现金净增加额**
2. **区别在于活动分类，不在于是否计入**
3. **现金净增加额 = 所有流入 - 所有流出**
4. **期末余额 = 期初余额 + 净增加额**

### 🔍 如何判断交易的活动类型？

- **经营活动** → 日常经营业务（房租、水电等）
- **投资活动** → 长期资产投资（装修、购置设备）
- **筹资活动** → 资金往来（押金、借款）

### ✅ 正确理解

```
❌ 错误：押金收入不计入现金流
✅ 正确：押金收入是筹资活动的现金流入

❌ 错误：装修费不影响现金
✅ 正确：装修费是投资活动的现金流出

❌ 错误：只有经营活动影响现金余额
✅ 正确：三种活动都影响现金余额
```
